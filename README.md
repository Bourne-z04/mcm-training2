# Problem A: How to Defend Against a Direct Free-Kick?

## 项目概述

本项目针对2018年俄罗斯世界杯葡萄牙对西班牙比赛中克里斯蒂亚诺·罗纳尔多（Cristiano Ronaldo）的经典任意球进球，进行了轨迹重建和防守策略分析。通过单目视觉几何和足球动力学建模，重建了足球在三维空间中的运动轨迹，并分析了不同防守策略的有效性。

## 问题背景

2018年俄罗斯世界杯被称为"定位球世界杯"，169个进球中有71个来自定位球，占比42%。罗纳尔多在比赛第87分钟的直接任意球进球成为经典案例，为任意球战术提供了基准研究对象。

## 求解流程

### 1. 建立真实足球场空间直角坐标系

#### 坐标系定义
- **原点**: 足球场左下角（从球门看守门员视角）
- **X轴**: 沿球场长度方向，从进攻方球门到防守方球门（52.5m）
- **Y轴**: 沿球场宽度方向，左侧为负，右侧为正（±34m）
- **Z轴**: 垂直向上，地面为0

#### 12个特征点坐标计算

基于标准足球场尺寸（105m×68m），计算得到12个特征点三维坐标：

| 特征点ID | 描述 | X(m) | Y(m) | Z(m) |
|---------|------|------|------|------|
| goal_left_bottom | 球门左下角 | 52.5 | -3.66 | 0 |
| goal_left_top | 球门左上角 | 52.5 | -3.66 | 2.44 |
| goal_right_bottom | 球门右下角 | 52.5 | 3.66 | 0 |
| goal_right_top | 球门右上角 | 52.5 | 3.66 | 2.44 |
| penalty_left | 点球点左侧 | 52.5 | -9.15 | 0 |
| penalty_right | 点球点右侧 | 52.5 | 9.15 | 0 |
| penalty_center | 点球点 | 52.5 | 0 | 0 |
| center_circle | 中圈中心 | 52.5 | 0 | 0 |
| corner_left_front | 前左角球点 | 105 | -34 | 0 |
| corner_right_front | 前右角球点 | 105 | 34 | 0 |
| corner_left_back | 后左角球点 | 0 | -34 | 0 |
| corner_right_back | 后右角球点 | 0 | 34 | 0 |

### 2. 手动打点和数据提取

#### 数据处理流程
1. **视频帧提取**: 从比赛录像中提取29帧关键画面
2. **特征点标注**: 在每帧图像中手动标注可见的特征点像素坐标
3. **足球位置标注**: 记录每帧中足球的像素坐标(u,v)

#### 数据格式
每帧数据包含：
- 特征点像素坐标：(u,v) pairs
- 足球像素坐标：(u_ball, v_ball)
- 帧编号：1-29

### 3. 数学模型

#### 视觉几何模型
基于单目视觉和DLT（Direct Linear Transformation）算法：

**投影矩阵计算**:
```
对于每帧t = 1到T:
1. 特征匹配：从2D像素点提取可见特征点
2. 构建线性方程组：A·p = 0
3. SVD分解：[U,S,V^T] = SVD(A)
4. 提取投影矩阵：P = V^T最后一行
5. 计算相机中心：C = Vh^T最后一行，C = C[:3]/C[3]
```

**视线射线构建**:
```
利用投影矩阵伪逆将足球像素坐标反投影到3D空间：
- 像素坐标：(u_ball, v_ball)
- 反投影：计算从相机中心C出发的视线方向向量d
- 存储观测：Obs_t = {C_t, d_t}
```

#### 足球动力学模型

**运动方程**:
```python
def ball_dynamics(t, state, Cd, Cl, omega_vec):
    # state = [x, y, z, vx, vy, vz]
    x, y, z, vx, vy, vz = state
    v_vec = np.array([vx, vy, vz])

    # 重力
    F_g = np.array([0, 0, -m*g])

    # 阻力 (Drag Force)
    Fd = -0.5 * rho * A * Cd * v_mag * v_vec

    # 马格努斯力 (Magnus Force)
    Fm = np.cross(omega_vec, v_vec)

    # 总力
    F_total = F_g + Fd + Fm
    acc = F_total / m

    return [vx, vy, vz, acc[0], acc[1], acc[2]]
```

**模型参数**:
- 质量 m = 0.436 kg
- 半径 radius = 0.11 m
- 截面积 A = π·radius²
- 空气密度 ρ = 1.225 kg/m³
- 重力加速度 g = 9.81 m/s²

### 4. 假设条件

- **相机模型**: 针孔相机模型，无畸变、无失真
- **特征点**: 所有标注的特征点坐标精确已知
- **物理模型**: 足球视为刚体球，忽略旋转衰减
- **空气动力学**: 使用简化阻力系数，忽略风速影响
- **时间同步**: 视频帧率与实际时间严格对应

### 5. 算法实现

#### 5.1 视觉几何解算 (Visual Geometry Solver)

```algorithm
For 每一帧 t = 1 to T do:
    特征匹配: 从 V_2D^(t) 中提取可见特征点，与 F_3D 进行匹配
    相机标定 (DLT算法):
        构建线性方程组 A·p = 0，其中 p 为投影矩阵 P_3×4 的向量形式
        对 A 进行奇异值分解: [U, S, V^T] = SVD(A)
        取 V^T 的最后一行作为投影矩阵 P_t 的解
    提取相机中心:
        对 P_t 进行分解得到相机光心坐标 C_t ∈ R^3
    构建视线射线:
        利用 P_t 伪逆将足球像素坐标 (u_ball, v_ball) 反投影
        计算从光心 C_t 指向足球的方向向量 d_t
    存储观测数据: Obs_t = {C_t, d_t}
End For
```

#### 5.2 优化算法 (L-BFGS-B)

```algorithm
Input: 初始猜测参数 x_0, 参数边界 l,u, 最大迭代次数 K_max, 收敛容差 ε
Output: 最优物理参数 x*

Procedure:
    初始化: k ← 0
    计算初始梯度 g_0 ← ∇f(x_0) (有限差分法)
    初始化近似海森逆矩阵 H_0 ← I
    存储历史集合 M ← ∅

    While ||g_k|| > ε and k < K_max do:
        a. 确定搜索方向: d_k = -H_k · g_k
           (广义柯西点算法确保不违反边界约束)

        b. 线搜索: 寻找步长 α_k 满足Wolfe条件
           f(x_k + α_k·d_k) < f(x_k) + c₁·α_k·g_k^T·d_k

        c. 更新参数: x_{k+1} ← x_k + α_k·d_k

        d. 更新梯度与历史:
           计算 g_{k+1} ← ∇f(x_{k+1})
           s_k = x_{k+1} - x_k
           y_k = g_{k+1} - g_k

        e. 迭代: k ← k + 1
    End While

Return x* = x_k
```

### 6. 求解实现

#### 主程序流程

```python
# 初始化猜测
# 根据第一帧视线与地面交点估算起始位置 r_0
# 根据经验设置初速度 v_0 ≈ 26.8 m/s, 角速度 ω ≈ 31.4 rad/s
# 构建初始参数向量 Θ_init = [vx0, vy0, vz0, wx, wy, wz, Cd, x0, y0]

# 非线性优化
Θ* = argmin_Θ ObjectiveFunction(Θ)

# 约束条件
# 速度范围: (-50, 50) m/s
# 角速度范围: (-50, 50) rad/s
# 阻力系数: (0.1, 0.5)
# 起始位置: 基于第一帧估算 ±5m

# 生成结果
Traj_3D = SimulateFlight(Θ*)
# 输出最优参数 Θ* 和轨迹文件
```

#### 优化目标函数

```python
def objective(params):
    # 积分求解轨迹
    sol = solve_ivp(ball_dynamics, [0, T], state0, t_eval=t_frames, args=(Cd, ω))

    # 计算每帧模拟位置到观测视线距离
    total_error = 0
    for i, data in enumerate(frames_data):
        C = data['C']          # 相机中心
        D = data['ray_dir']    # 视线方向 (单位向量)
        P_sim = sim_positions[i]  # 模拟位置

        # 点到直线距离
        CP = P_sim - C
        cross_prod = np.cross(CP, D)
        dist = np.linalg.norm(cross_prod)  # ||D|| = 1

        total_error += dist**2

    return total_error
```

### 7. 轨迹重建结果

程序成功运行优化，得到以下最优参数：

#### 优化结果
- **优化成功**: True
- **最终误差**: 0.783
- **初速度**: vx₀ = 27.75 m/s, vy₀ = -5.10 m/s, vz₀ = 10.47 m/s (|v₀| = 30.09 m/s)
- **角速度**: ωx = 0.149 rad/s, ωy = 0.056 rad/s, ωz = 0.140 rad/s (|ω| = 0.212 rad/s)
- **阻力系数**: Cd = 0.476
- **起始位置**: x₀ = 31.22 m, y₀ = -2.25 m, z₀ = 0 m

#### 轨迹分析
- **到达球门时间**: 0.99秒
- **到达球门高度**: 2.14米（球门范围内，球门高度2.44m）
- **轨迹输出**: 已生成120个轨迹点，保存为CSV文件

### 8. 误差分析

#### 误差来源

1. **手动标点误差**
   - 像素坐标标注精度：±1-2像素
   - 特征点识别误差：主观判断导致的系统误差
   - 足球位置标注误差：运动模糊导致的定位不准

2. **DLT算法局限性**
   - 最小二乘解的数值稳定性
   - 特征点匹配准确性影响
   - 相机模型假设的适用性

3. **物理模型简化**
   - 空气阻力模型的简化（忽略紊流效应）
   - 马格努斯力计算的近似
   - 旋转衰减的忽略

4. **时间同步误差**
   - 视频帧率与实际时间的对应关系
   - 足球运动的非连续性假设

### 9. 项目文件结构

```
mcm/training2/
├── data/                    # 数据文件
│   └── soccer_field_features.csv
├── solve/                   # 求解脚本
│   ├── q1.py               # 主求解程序
│   └── optimized_trajectory.csv  # 优化轨迹输出
├── analysis/                # 分析脚本
│   ├── q1_analysis.py      # 灵敏度分析
│   └── sensitivity_analysis.png  # 分析结果图
├── visual/                  # 可视化
│   ├── trajectory_*.png    # 轨迹图
│   └── trajectory_3d_interactive.html  # 3D交互图
└── question/               # 问题描述
    └── Problem_A.md
```

### 10. 技术实现细节

#### 依赖库
- numpy: 数值计算
- scipy: 优化和ODE求解
- pandas: 数据处理
- matplotlib: 可视化

#### 计算性能
- DLT算法: 每帧<0.1秒
- 轨迹优化: 约50-100次函数评估，每次<1秒
- 灵敏度分析: 9×21×2=378次模拟，约5分钟

### 11. 结论

通过单目视觉几何和足球动力学建模成功重建了罗纳尔多经典任意球轨迹。程序实现了从视频帧数据到三维轨迹的完整求解流程，包括：

1. **视觉几何重建**: 使用DLT算法从2D像素坐标计算相机参数和视线射线
2. **轨迹优化**: 通过L-BFGS-B算法最小化观测误差，获得最优物理参数
3. **结果验证**: 优化收敛良好，最终误差0.783，轨迹成功穿过球门区域

该方法为任意球轨迹分析提供了有效的计算框架，为后续的防守策略研究奠定了基础。

---


